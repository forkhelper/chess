<html>
<head>
</head>
<body>
<script src="http://codeorigin.jquery.com/jquery-2.0.3.min.js"></script>
<script src="http://dglittle.github.io/gl519/index.js"></script>
<script src="chess.js"></script>
<script>

function makeDraggable(d, onDrop) {
	function getOffset(from, to) {
		return {
			left : to.pageX - from.left,
			top : to.pageY - from.top
		}
	}
	// d.mousedown(function (e) {
	// 	e.preventDefault()
	// 	var pos = d.offset()
	// 	var oldParent = d.parent()
	// 	$('body').append(d)
	// 	d.offset(pos)
	// 	var offset = getOffset(pos, e)
	// 	var mousemove = function (e) {
	// 		d.offset(getOffset(offset, e))
	// 	}
	// 	var mouseup = function (e) {
	// 		$(document).off('mousemove', mousemove).off('mouseup', mouseup)
	// 		pos = d.offset()
	// 		oldParent.append(d)
	// 		d.offset(pos)
	// 		onDrop(e.pageX, e.pageY)
	// 	}
	// 	$(document).on('mousemove', mousemove).on('mouseup', mouseup)
	// })
	d.on('touchstart', function (e) {
		e = e.originalEvent
		e.preventDefault()
		var pos = d.offset()
		var oldParent = d.parent()
		$('body').append(d)
		d.offset(pos)
		var offset = getOffset(pos, e.touches[0])

		console.log('pos', pos)
		console.log('offset', offset)

		var mousemove = function (e) {
			e = e.originalEvent
			d.offset(getOffset(pos, e.touches[0]))
		}
		var mouseup = function (e) {
			e = e.originalEvent
			$(document).off('touchmove', mousemove).off('touchend', mouseup)
			pos = d.offset()
			oldParent.append(d)
			d.offset(pos)
			onDrop(e.touches[0].pageX, e.touches[0].pageY)
		}
		$(document).on('touchmove', mousemove).on('touchend', mouseup)
	})
}

function drawChessBoard(fen, size, onMove) {
	fen = fen || "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR"
	fen = fen.split(/ /)[0]
	fen = fen.replace(/\d/g, function (x) { return new Array(1 * x + 1).join(' ') }).replace(/\//g, '')

	size = size || 400
	var squareSize = size / 8

	var blackSquareColor = 'lightgrey'
	var whiteSquareColor = 'white'

	var blackPieceColor = 'black'
	var whitePieceColorBottom = 'white'
	var whitePieceColorTop = 'black'

	var pieces = {
		'P' : '\u2659',
		'R' : '\u2656',
		'N' : '\u2658',
		'B' : '\u2657',
		'K' : '\u2654',
		'Q' : '\u2655',
		'p' : '\u265f',
		'r' : '\u265c',
		'n' : '\u265e',
		'b' : '\u265d',
		'k' : '\u265a',
		'q' : '\u265b'
	}

	var d = $('<div/>').css({
		width : size,
		height : size
	})

	function makeSquare() {
		return $('<div/>').css({
			width : squareSize,
			height : squareSize,
			'text-align' : 'center',
			'vertical-align' : 'top',
			'font-size' : squareSize * .9,
			cursor : 'default'
		})
	}

	for (var y = 0; y < 8; y++) {
		for (var x = 0; x < 8; x++) {
			var square = makeSquare().css({
				float : 'left',
				background : (x + y) % 2 == 0 ? whiteSquareColor : blackSquareColor
			})
			var piece = pieces[fen[y * 8 + x]]
			if (piece) {
				var pieceDiv
				if (piece >= '\u265a') {
					pieceDiv = makeSquare().css({
						color : blackPieceColor
					}).text(piece)
				} else {
					pieceDiv = makeSquare()
					pieceDiv.append(makeSquare().css({
						color : whitePieceColorBottom
					}).text(whitePieceColorBottom ? String.fromCharCode(piece.charCodeAt(0) + 6) : ''))
					pieceDiv.append(makeSquare().css({
						color : whitePieceColorTop,
						position : 'relative',
						top : '-' + squareSize + 'px'
					}).text(whitePieceColorTop ? piece : ''))
				}
				;(function () {
					function getPos(x, y) {
						if (x < 0 || x > 7 || y < 0 || y > 7)
							return 'offboard'
						return String.fromCharCode('a'.charCodeAt(0) + x) + (8 - y)
					}
					var from = getPos(x, y)
					makeDraggable(pieceDiv, function (x, y) {
						var pos = d.offset()
						x = Math.floor((x - pos.left) / squareSize)
						y = Math.floor((y - pos.top) / squareSize)
						onMove(from + getPos(x, y))
					})
				})();
				square.append(pieceDiv)
			}
			d.append(square)
		}
	}

	return d
}

function drawChessGame(fen) {
	var d = $('<div/>')

	function redrawBoard() {
		d.empty().append(drawChessBoard(fen, Math.min(window.innerWidth, window.innerHeight), function (move) {
			fen = applyMove(fen, move) || fen
			redrawBoard()
		}))
	}
	redrawBoard()

	return d
}

$(function () {

	///
	var preventDefault = false
	$('body').append($('<button/>').text('preventDefault').click(function () {
		preventDefault = !preventDefault
		$(this).css('background', preventDefault ? 'red' : 'grey')
	}))

	var output = [['test', 0]]
	var textOutput = $('<textarea style="width:50%;height:80%"/>')
	$('body').append($('<br/>')).append(textOutput)
	function captureEvent(e) {
		$(document).on(e, function (ee) {
			if (preventDefault)
				ee.preventDefault()
			if (e == output[output.length - 1][0]) {
				output[output.length - 1][1]++
			} else {
				output.push([e, 1])
			}

			s = []
			_.each(output, function (o) {
				s.push(o[0] + (o[1] > 1 ? '(' + o[1] + ')': ''))
			})
			textOutput.val(s.join('\n'))
		})
	}
	_.each(['mousedown', 'mouseup', 'mousemove', 'touchstart', 'touchmove', 'touchend'], captureEvent)
	return
	///


	$('body').css('margin', '0px').append(drawChessGame(startingFen))
})

</script>
</body>
</html>
